# ã€Šäº¿çº§æµé‡ç³»ç»Ÿå¤šçº§ç¼“å­˜æ¶æ„2ã€‹

# Lua + 

## è¯¾ç¨‹ä¸»è¦å†…å®¹

### Nginxç¼“å­˜

#### Nginxå…¨å±€å…±äº«å†…å­˜ç¼“å­˜

```lua
lua_shared_dict shared_data 1m;


------


local shared_data = ngx.shared.shared_data  

local i = shared_data:get("i")  

if not i then  

    i = 1  

    shared_data:set("i", i)  

    ngx.say("lazy set i ", i, "<br/>")  
end  
 

i = shared_data:incr("i", 1)  

ngx.say("i=", i, "<br/>")
```



#### lua-resty-lrucache

Lua å®ç°çš„ä¸€ä¸ªç®€å•çš„ LRU ç¼“å­˜ï¼Œé€‚åˆåœ¨ Lua ç©ºé—´é‡Œç›´æ¥ç¼“å­˜è¾ƒä¸ºå¤æ‚çš„ Lua æ•°æ®ç»“æ„ï¼š

å®ƒç›¸æ¯” ngx_lua å…±äº«å†…å­˜å­—å…¸å¯ä»¥çœå»è¾ƒæ˜‚è´µçš„åºåˆ—åŒ–æ“ä½œï¼Œç›¸æ¯” memcached è¿™æ ·çš„å¤–éƒ¨æœåŠ¡åˆèƒ½çœå»è¾ƒæ˜‚è´µçš„ socket æ“ä½œ

lrucache æœ‰ä¸¤ç§å®ç°

- resty.lrucache
  - é€‚åˆç”¨æ¥ç¼“å­˜å‘½ä¸­ç‡é«˜æˆ–è¯»æ“ä½œè¿œè¿œå¤§äºå†™æ“ä½œçš„ç¼“å­˜ä¸šåŠ¡
- resty.lrucache.pureffi
  - é€‚åˆç”¨æ¥ç¼“å­˜å‘½ä¸­ç‡ä½æˆ–éœ€è¦å¯¹keyè¿›è¡Œé¢‘ç¹å¢ã€åˆ æ“ä½œçš„ç¼“å­˜ä¸šåŠ¡

```lua
local lrucache = require "resty.lrucache"

local c, err = lrucache.new(200)



	c:set("dog", 32)
    c:set("cat", 56)
    ngx.say("dog: ", c:get("dog"))
    ngx.say("cat: ", c:get("cat"))

    c:set("dog", { age = 10 }, 0.1)  -- expire in 0.1 sec
    c:delete("dog")

```

https://github.com/openresty/lua-resty-lrucache#name



##### å®ä¾‹

```lua
local mycache = require("mycache")  
local count = mycache.get("count") or 0  
count = count + 1  
mycache.set("count", count, 10 * 60 * 60) --10åˆ†é’Ÿ  
ngx.say(mycache.get("count"))     

```

**mycache.lua**

```lua
local lrucache = require("resty.lrucache")  
--åˆ›å»ºç¼“å­˜å®ä¾‹ï¼Œå¹¶æŒ‡å®šæœ€å¤šç¼“å­˜å¤šå°‘æ¡ç›®  
local cache, err = lrucache.new(200)  
if not cache then  
   ngx.log(ngx.ERR, "create cache error : ", err)  
end  
  
local function set(key, value, ttlInSeconds)  
    cache:set(key, value, ttlInSeconds)  
end  
  
local function get(key)  
    return cache:get(key)  
end  
  
local _M = {  
  set = set,  
  get = get  
}  
return _M

```



##### tmpfs

åœ¨Linuxç³»ç»Ÿå†…å­˜ä¸­çš„è™šæ‹Ÿç£ç›˜æ˜ å°„ï¼Œå¯ä»¥ç†è§£ä¸ºä½¿ç”¨ç‰©ç†å†…å­˜å½“åšç£ç›˜ï¼Œåˆ©ç”¨è¿™ç§æ–‡ä»¶ç³»ç»Ÿï¼Œå¯ä»¥æœ‰æ•ˆæé«˜åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹çš„ç£ç›˜è¯»å†™ï¼Œä½†æ˜¯é‡å¯åæ•°æ®ä¼šä¸¢å¤±ã€‚

###### æŸ¥çœ‹tmpfså‘½ä»¤ï¼š



![](images/1569584708275.png)

###### ç³»ç»Ÿé»˜è®¤å¼€å¯ï¼Œå¤§å°çº¦ä¸ºç‰©ç†å†…å­˜ä¸€åŠ



###### æŸ¥çœ‹ç‰©ç†å†…å­˜åˆ©ç”¨æƒ…å†µ

![1569584752960](images/1569584752960.png)



tmpfsæ²¡æœ‰å ç”¨å†…å­˜ç©ºé—´ï¼Œåªæœ‰åœ¨å†™å…¥æ•°æ®çš„æ—¶å€™æ‰ä¼šå ç”¨å®é™…çš„ç‰©ç†å†…å­˜

###### è°ƒæ•´å¤§å°

ä¸´æ—¶ä¿®æ”¹æ–¹å¼å¦‚ä¸‹ï¼Œç«‹å³ç”Ÿæ•ˆä½†é‡å¯åä¼šæ¢å¤

![1569584781944](images/1569584781944.png)



###### æ°¸ä¹…ä¿®æ”¹ /etc/fstabæ–‡ä»¶

![1569584800821](images/1569584800821.png)







#### http_proxy æœ¬åœ°ç£ç›˜ç¼“å­˜

```nginx
proxy_cache_path /path/to/cache levels=1:2 keys_zone=my_cache:10m max_size=10g inactive=60m use_temp_path=off;

server {

â€‚â€‚â€‚â€‚ set $upstream http://ip:port

â€‚â€‚â€‚â€‚ â€‚â€‚â€‚â€‚ location / {

â€‚â€‚â€‚â€‚ â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚ â€‚â€‚â€‚â€‚ proxy_cache my_cache;

â€‚â€‚â€‚â€‚ â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚ â€‚â€‚â€‚â€‚ proxy_pass $upstream;
             }

}
```

` /path/to/cache`  #æœ¬åœ°è·¯å¾„ï¼Œç”¨æ¥è®¾ç½®Nginxç¼“å­˜èµ„æºçš„å­˜æ”¾åœ°å€

`  levels `         #é»˜è®¤æ‰€æœ‰ç¼“å­˜æ–‡ä»¶éƒ½æ”¾åœ¨åŒä¸€ä¸ª`/path/to/cache`ä¸‹ï¼Œä½†æ˜¯ä¼šå½±å“ç¼“å­˜çš„æ€§èƒ½ï¼Œå› æ­¤é€šå¸¸ä¼šåœ¨`/path/to/cache`ä¸‹é¢å»ºç«‹å­ç›®å½•ç”¨æ¥åˆ†åˆ«å­˜æ”¾ä¸åŒçš„æ–‡ä»¶ã€‚å‡è®¾`levels=1:2`ï¼ŒNginxä¸ºå°†è¦ç¼“å­˜çš„èµ„æºç”Ÿæˆçš„`key`ä¸º`f4cd0fbc769e94925ec5540b6a4136d0`ï¼Œé‚£ä¹ˆ`key`çš„æœ€åä¸€ä½0ï¼Œä»¥åŠå€’æ•°ç¬¬2-3ä½6dä½œä¸ºä¸¤çº§çš„å­ç›®å½•ï¼Œä¹Ÿå°±æ˜¯è¯¥èµ„æºæœ€ç»ˆä¼šè¢«ç¼“å­˜åˆ°`/path/to/cache/0/6d`ç›®å½•ä¸­

`key_zone`        #åœ¨å…±äº«å†…å­˜ä¸­è®¾ç½®ä¸€å—å­˜å‚¨åŒºåŸŸæ¥å­˜æ”¾ç¼“å­˜çš„`key`å’Œ`metadata`ï¼ˆç±»ä¼¼ä½¿ç”¨æ¬¡æ•°ï¼‰ï¼Œè¿™æ ·nginxå¯ä»¥å¿«é€Ÿåˆ¤æ–­ä¸€ä¸ªrequestæ˜¯å¦å‘½ä¸­æˆ–è€…æœªå‘½ä¸­ç¼“å­˜ï¼Œ1må¯ä»¥å­˜å‚¨8000ä¸ªkeyï¼Œ10må¯ä»¥å­˜å‚¨80000ä¸ªkey

`max_size`        #æœ€å¤§cacheç©ºé—´ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œä¼šä½¿ç”¨æ‰æ‰€æœ‰disk spaceï¼Œå½“è¾¾åˆ°é…é¢åï¼Œä¼šåˆ é™¤æœ€å°‘ä½¿ç”¨çš„cacheæ–‡ä»¶

` inactive`        #æœªè¢«è®¿é—®æ–‡ä»¶åœ¨ç¼“å­˜ä¸­ä¿ç•™æ—¶é—´ï¼Œæœ¬é…ç½®ä¸­å¦‚æœ60åˆ†é’Ÿæœªè¢«è®¿é—®åˆ™ä¸è®ºçŠ¶æ€æ˜¯å¦ä¸ºexpiredï¼Œç¼“å­˜æ§åˆ¶ç¨‹åºä¼šåˆ æ‰æ–‡ä»¶ã€‚inactiveé»˜è®¤æ˜¯10åˆ†é’Ÿã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œinactiveå’Œexpiredé…ç½®é¡¹çš„å«ä¹‰æ˜¯ä¸åŒçš„ï¼Œexpiredåªæ˜¯ç¼“å­˜è¿‡æœŸï¼Œä½†ä¸ä¼šè¢«åˆ é™¤ï¼Œinactiveæ˜¯åˆ é™¤æŒ‡å®šæ—¶é—´å†…æœªè¢«è®¿é—®çš„ç¼“å­˜æ–‡ä»¶

` use_temp_path`   #å¦‚æœä¸ºoffï¼Œåˆ™nginxä¼šå°†ç¼“å­˜æ–‡ä»¶ç›´æ¥å†™å…¥æŒ‡å®šçš„cacheæ–‡ä»¶ä¸­ï¼Œè€Œä¸æ˜¯ä½¿ç”¨temp_pathå­˜å‚¨ï¼Œofficialå»ºè®®ä¸ºoffï¼Œé¿å…æ–‡ä»¶åœ¨ä¸åŒæ–‡ä»¶ç³»ç»Ÿä¸­ä¸å¿…è¦çš„æ‹·è´

`proxy_cache`     #å¯ç”¨proxy cacheï¼Œå¹¶æŒ‡å®škey_zoneã€‚å¦å¤–ï¼Œå¦‚æœproxy_cache offè¡¨ç¤ºå…³é—­æ‰ç¼“å­˜ã€‚

### lua-resty-redisè®¿é—®redis

#### å¸¸ç”¨æ–¹æ³•

```lua
local res, err = red:get("key")

local res, err = red:lrange("nokey", 0, 1)

ngx.say("res:",cjson.encode(res))
```



#### åˆ›å»ºè¿æ¥

```lua
red, err = redis:new()

ok, err = red:connect(host, port, options_table?)
```



#### timeout

```lua
red:set_timeout(time)
```

#### keepalive

```lua
red:set_keepalive(max_idle_timeout, pool_size)
```





#### close

```
ok, err = red:close()
```

 null 

nil

error 

exception

crash

#### pipeline

```nginx
red:init_pipeline()

results, err = red:commit_pipeline()
```

#### è®¤è¯

```nginx
    local res, err = red:auth("foobared")

    if not res then

        ngx.say("failed to authenticate: ", err)

        return
end
```





#### redis-clusteræ”¯æŒ

https://github.com/steve0511/resty-redis-cluster

 

### redis2-nginx-module 

redis2-nginx-moduleæ˜¯ä¸€ä¸ªæ”¯æŒ Redis 2.0 åè®®çš„ Nginx upstream æ¨¡å—ï¼Œå®ƒå¯ä»¥è®© Nginx ä»¥éé˜»å¡æ–¹å¼ç›´æ¥é˜²é—®è¿œæ–¹çš„ Redis æœåŠ¡ï¼ŒåŒæ—¶æ”¯æŒ TCP åè®®å’Œ Unix Domain Socket æ¨¡å¼ï¼Œå¹¶ä¸”å¯ä»¥å¯ç”¨å¼ºå¤§çš„ Redis è¿æ¥æ± åŠŸèƒ½ã€‚

https://github.com/openresty/redis2-nginx-module

#### test

```nginx
location = /foo {

default_type text/html;

     redis2_query auth 123123;

     set $value 'first';

     redis2_query set one $value;

     redis2_pass 192.168.199.161:6379;

 }
```





#### get

```nginx
location = /get {

default_type text/html;

     redis2_pass 192.168.199.161:6379;

     redis2_query auth 123123;

     set_unescape_uri $key $arg_key;  # this requires ngx_set_misc

     redis2_query get $key;

}
```





#### set

```nginx
# GET /set?key=one&val=first%20value

location = /set {

default_type text/html;

redis2_pass 192.168.199.161:6379;

redis2_query auth 123123;
 

     set_unescape_uri $key $arg_key;  # this requires ngx_set_misc

     set_unescape_uri $val $arg_val;  # this requires ngx_set_misc

     redis2_query set $key $val;

 }
```





#### pipeline



```nginx
     set $value 'first';

     redis2_query set one $value;

     redis2_query get one;

     redis2_query set one two;

     redis2_query get one;

redis2_query del key1;
```

#### list

```lua
    redis2_query lpush key1 C;

    redis2_query lpush key1 B;

    redis2_query lpush key1 A;

redis2_query lrange key1 0 -1;
```





#### é›†ç¾¤

```nginx
upstream redis_cluster {

     server 192.168.199.161:6379;

     server 192.168.199.161:6379;

 }

location = /redis {

default_type text/html;

         redis2_next_upstream error timeout invalid_response;

         redis2_query get foo;

         redis2_pass redis_cluster;
   }
```







## URLä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½å‡è¡¡

æœ‰é’ˆå¯¹æ€§çš„å¯¹urlè¿›è¡Œä¸€è‡´æ€§hash å®šå‘è´Ÿè½½åˆ°åç«¯Nginx 

æé«˜Nginxç¼“å­˜ç³»ç»Ÿå‘½ä¸­ç‡

#### nginx url_hash

Nginxç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œåœ¨è½¬å‘è¯·æ±‚æ—¶å¦‚æœåç«¯æœåŠ¡å™¨å®•æœºï¼Œä¼šå¯¼è‡´503é”™è¯¯

#### lua-resty-http

### GitHubä¸»é¡µ

https://github.com/ledgetech/lua-resty-http

### å®‰è£…ç»„ä»¶

wget https://raw.githubusercontent.com/pintsized/lua-resty-http/master/lib/resty/http_headers.lua  

wget https://raw.githubusercontent.com/pintsized/lua-resty-http/master/lib/resty/http.lua 



 

```lua
local http = require("resty.http")  

local httpc = http.new()  
  
local resp, err = httpc:request_uri("http://www.sogou.com", {  
    method = "GET",  
    path = "/sogou?query=resty.http",  
    headers = {  
        ["User-Agent"] = "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.111 Safari/537.36"  
    }  
})  
  
if not resp then  
    ngx.say("request error :", err)  
    return  
end  
  
 
ngx.status = resp.status  
  
  
for k, v in pairs(resp.headers) do  
    if k ~= "Transfer-Encoding" and k ~= "Connection" then  
        ngx.header[k] = v  
    end  
end  
  
ngx.say(resp.body)  
  
httpc:close()

```

httpæ¨¡å—åŠ å…¥

```
resolver 8.8.8.8;
```



### lua-resty-httpå®ç°ä¸€è‡´æ€§hashè´Ÿè½½å‡è¡¡

```lua
local http = require("resty.http")  
local httpc = http.new()  

local hosts = {"192.168.150.111","192.168.150.112"}

local item_id= ngx.var.arg_id

local id_hash = ngx.crc32_long(item_id)
local index = (id_hash % 2) +1
  
local resp, err = httpc:request_uri("http://"..hosts[index], {  
    method = "GET",  
    path = "/sogou?query=resty.http",  
    headers = {  
        ["User-Agent"] = "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.111 Safari/537.36"  
    }  
})  
  
if not resp then  
    ngx.say("request error :", err)  
    return  
end  
  
 
ngx.say(resp.body)  
  
httpc:close()

```

## æ¨¡æ¿å®æ—¶æ¸²æŸ“ lua-resty-template

https://github.com/bungle/lua-resty-template

å¦‚æœå­¦ä¹ è¿‡JavaEEä¸­çš„servletå’ŒJSPçš„è¯ï¼Œåº”è¯¥çŸ¥é“JSPæ¨¡æ¿æœ€ç»ˆä¼šè¢«ç¿»è¯‘æˆServletæ¥æ‰§è¡Œï¼›

è€Œlua-resty-templateæ¨¡æ¿å¼•æ“å¯ä»¥è®¤ä¸ºæ˜¯JSPï¼Œå…¶æœ€ç»ˆä¼šè¢«ç¿»è¯‘æˆLuaä»£ç ï¼Œç„¶åé€šè¿‡ngx.printè¾“å‡ºã€‚   

lua-resty-templateå¤§ä½“å†…å®¹æœ‰ï¼š 

l   æ¨¡æ¿ä½ç½®ï¼šä»å“ªé‡ŒæŸ¥æ‰¾æ¨¡æ¿ï¼› 

l   å˜é‡è¾“å‡º/è½¬ä¹‰ï¼šå˜é‡å€¼è¾“å‡ºï¼› 

l   ä»£ç ç‰‡æ®µï¼šæ‰§è¡Œä»£ç ç‰‡æ®µï¼Œå®Œæˆå¦‚if/elseã€forç­‰å¤æ‚é€»è¾‘ï¼Œè°ƒç”¨å¯¹è±¡å‡½æ•°/æ–¹æ³•ï¼› 

l   æ³¨é‡Šï¼šè§£é‡Šä»£ç ç‰‡æ®µå«ä¹‰ï¼› 

l   includeï¼šåŒ…å«å¦ä¸€ä¸ªæ¨¡æ¿ç‰‡æ®µï¼› 

l   å…¶ä»–ï¼šlua-resty-templateè¿˜æä¾›äº†ä¸éœ€è¦è§£æç‰‡æ®µã€ç®€å•å¸ƒå±€ã€å¯å¤ç”¨çš„ä»£ç å—ã€å®æŒ‡ä»¤ç­‰æ”¯æŒã€‚

åŸºç¡€è¯­æ³•

l   {(include_file)}ï¼šåŒ…å«å¦ä¸€ä¸ªæ¨¡æ¿æ–‡ä»¶ï¼›

l   {* var *}ï¼šå˜é‡è¾“å‡ºï¼›

l   {{ var }}ï¼šå˜é‡è½¬ä¹‰è¾“å‡ºï¼›

l   {% code %}ï¼šä»£ç ç‰‡æ®µï¼›

l   {# comment #}ï¼šæ³¨é‡Šï¼›

l   {-raw-}ï¼šä¸­é—´çš„å†…å®¹ä¸ä¼šè§£æï¼Œä½œä¸ºçº¯æ–‡æœ¬è¾“å‡ºï¼›


### è®¾ç½®æ¨¡ç‰ˆä»¬çš„æ ¹ç›®å½•
å®šä¹‰å˜é‡ï¼Œåœ¨serverçš„å¤§æ‹¬å·ä¸‹è¾“å…¥ï¼š  
`set $template_root /usr/local/openresty/nginx/template;`  
è¿™å°±è®¾ç½®å¥½äº†è¢«æ¸²æŸ“çš„æ¨¡æ¿çš„æ ¹ç›®å½•ï¼Œå°†æ¥å°±ç”¨Luaè„šæœ¬å¾€æ¨¡æ¿é‡Œé¢å¡«å……æ•°æ®{{DATA}}

### luaä»£ç çƒ­åŠ è½½

åœ¨httpæ¨¡å—ä¸­åŠ å…¥

```
lua_code_cache off;
```

reloadåNginxä¼šæç¤ºå½±å“æ€§èƒ½ï¼Œè®°å¾—åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å…³æ‰ã€‚

![1569585068623](images/1569585068623.png)

### æµ‹è¯•

### ä¸€ã€åˆå§‹åŒ–

```
-- Using template.new
local template = require "resty.template"
-- Luaè„šæœ¬é‡Œå…³é—­ç¼“å­˜
template.caching(false)

local view = template.new "view.html"
view.message = "Hello, World!"
view:render()

-- Using template.render
-- template.render("view.html", { message = "Hel11lo, Worl1d!" })


```

### äºŒã€æ‰§è¡Œå‡½æ•°ï¼Œå¾—åˆ°æ¸²æŸ“ä¹‹åçš„å†…å®¹

```
local func = template.compile("view.html")  

local content = func(context)  

ngx.say("xx:",content) 
```





### resty.template.html

```lua
local template = require("resty.template")
local html = require "resty.template.html"

template.render([[
<ul>
{% for _, person in ipairs(context) do %}
    {*html.li(person.name)*} --
{% end %}
</ul>
<table>
{% for _, person in ipairs(context) do %}
    <tr data-sort="{{(person.name or ""):lower()}}">
        {*html.td{ id = person.id }(person.name)*}
    </tr>
{% end %}
</table>]], {
    { id = 1, name = "Emma"},
    { id = 2, name = "James" },
    { id = 3, name = "Nicholas" },
    { id = 4 }
})

```

### æ¨¡æ¿å†…å®¹

```html
<!DOCTYPE html>
<html>
<body>
  <h1>{{message}}</h1>
</body>
</html>

```

### å¤šå€¼ä¼ å…¥

```lua
template.caching(false)
local template = require("resty.template")
local context = {
    name = "lucy",
    age = 50,
}
template.render("view.html", context)

```

### æ¨¡æ¿å†…å®¹

```lua
<!DOCTYPE html>
<html>
<body>
  <h1>name:{{name}}</h1>
  <h1>age:{{age}}</h1>
</body>
</html>

```



### æ¨¡æ¿ç®¡ç†ä¸ç¼“å­˜

æ¨¡æ¿ç¼“å­˜ï¼šé»˜è®¤å¼€å¯ï¼Œå¼€å‘ç¯å¢ƒå¯ä»¥æ‰‹åŠ¨å…³é—­

```template.caching(true)```

æ¨¡æ¿æ–‡ä»¶éœ€è¦ä¸šåŠ¡ç³»ç»Ÿæ›´æ–°ä¸ç»´æŠ¤ï¼Œå½“æ¨¡æ¿æ–‡ä»¶æ›´æ–°åï¼Œå¯ä»¥é€šè¿‡æ¨¡æ¿ç‰ˆæœ¬å·æˆ–æ¶ˆæ¯é€šçŸ¥Openrestyæ¸…ç©ºç¼“å­˜é‡è½½æ¨¡æ¿åˆ°å†…å­˜ä¸­

`template.cache = {}`

### åˆ¤æ–­ä½•æ—¶è¿”å›é™æ€é¡µé¢æˆ–è€…è¯»å–æ•°æ®åº“
æ‰“å¼€error_page 404å¹¶ä¸”åŠ ä¸€ä¸ªlocationæ¡ç›®ï¼š
```
error_page  404              /404.html;
location = /404.html {
	default_type text/html;
        content_by_lua '
            ngx.say("404å•¦")
        ';
}
```
ä¸‹é¢ç»§ç»­ä¿®æ”¹ï¼Œæ‹¦æˆªé€ æˆ404çš„é‚£ä¸ªuriå’Œå‚æ•°çš„å€¼ï¼š
```
error_page  404              /404.html?id=$arg_id&uri=$uri;
location = /404.html {
    default_type text/html;
    content_by_lua '
	ngx.say("uri:"..ngx.var.arg_uri)
	ngx.say("arg:"..ngx.var.arg_id)
    ';
}
```
é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œè¿™ä¸ªuriæ˜¯å’±è‡ªå·±æ‘¸ç´¢å‡ºæ¥çš„ï¼Œä¸€æ¬¡æˆåŠŸï¼Œé‡å¯openrestyå†è®¿é—®ä¸å­˜åœ¨çš„é¡µé¢ï¼š`http://192.168.1.2/item-100.html?id=50` åˆ™æ‰“å°å‡ºäº†ï¼š
```
uri:/item-100.html arg:50
```
å¤ªé«˜å…´å•¦ğŸ˜Š

é«˜å…´å®Œäº†ï¼Œå†·é™ä¸‹æ¥æ€»ç»“ä¸€ä¸‹ï¼šerror_pageå†å‡ºç°äº†404é”™è¯¯ä¹‹åï¼Œä¼šè½¬åˆ°ä¸€ä¸ªå«"/404.html"çš„locationï¼Œè¿™é‡Œè½¬çš„æ—¶å€™ï¼ŒæŠŠæŠ¥404çš„è¿™ä¸ªé¡µé¢çš„uriå’Œå‚æ•°ï¼ˆ$arg_id&uri=$uriï¼‰å–åˆ°ï¼Œå¹¶ä¸”éƒ½è½¬äº¤ç»™é‚£ä¸ªæ–°çš„locationã€‚åˆ°æ­¤ä¸ºæ­¢ï¼Œå“ªä¸ªuriä»€ä¹ˆå‚æ•°æŠ¥é”™äº†ã€‚  
æ¥ä¸‹æ¥ç”¨`local id = string.sub(uri, 7, -6)`æˆªå–itemçš„idï¼Œå› ä¸ºurié•¿è¿™æ ·ï¼š`/item-100.html`,æ‰€ä»¥ä»ç¬¬7ä¸ªå­—ç¬¦å¼€å§‹ï¼ˆluaå­—ç¬¦ä¸²ä¸‹æ ‡ä»1å¼€å§‹ï¼Œè€Œä¸æ˜¯0ï¼‰æˆªå–åˆ°å€’æ•°ç¬¬6ä¸ªã€‚ç„¶åå°±å¯ä»¥æ‹¿ç€å®ƒå»æ•°æ®åº“æ‰¾äº†ï¼š
```
# é‡åˆ°404 é”™è¯¯å°±è½¬åˆ°ä¸€ä¸ªå«"/404.html"çš„location 
error_page  404              /404.html?id=$arg_id&uri=$uri;
location = /404.html {
    default_type text/html;
    content_by_lua '
	local template = require "resty.template"
	ngx.say("uri:"..ngx.var.arg_uri)
	ngx.say("arg:"..ngx.var.arg_id)
	local uri = ngx.var.arg_uri
	local id = string.sub(uri, 7, -6)
	local mysql = require "resty.mysql"
	local db,err = mysql:new()
	db:set_timeout(1000)

	local conn,str_err = db:connect {
	      host = "192.168.1.102",
	      port = "3306",
	      user = "root",
	      password = "^abc123$",
	      database = "arica"
	}

	if not conn then
	      ngx.say("connect -- failed to connect to remote mysql server. -- str_err: ", str_err)
	      return
	end

	ngx.say("connect success! connect: ", conn)

	local res = db:query("select * from item where id = "..id)
	local view = template.new "index.html"
	view.item = res[1]
	db:set_keepalive(1500, 5000)
	view:render()
    ';
}
```

### å®Œæ•´é¡µé¢



```lua
local template = require("resty.template")
template.caching(false)
local context = {
    title = "æµ‹è¯•",
    name = "lucy",
    description = "<script>alert(1);</script>",
    age = 40,
    hobby = {"ç”µå½±", "éŸ³ä¹", "é˜…è¯»"},
    score = {è¯­æ–‡ = 90, æ•°å­¦ = 80, è‹±è¯­ = 70},
    score2 = {
        {name = "è¯­æ–‡", score = 90},
        {name = "æ•°å­¦", score = 80},
        {name = "è‹±è¯­", score = 70},
    }
}

template.render("view.html", context)

```

### æ¨¡æ¿

```html
{(header.html)}  
   <body>  
      {# ä¸è½¬ä¹‰å˜é‡è¾“å‡º #}  
      å§“åï¼š{* string.upper(name) *}<br/>  
      {# è½¬ä¹‰å˜é‡è¾“å‡º #}  
      ç®€ä»‹ï¼š{{description}}
           ç®€ä»‹ï¼š{* description *}<br/>  
      {# å¯ä»¥åšä¸€äº›è¿ç®— #}  
      å¹´é¾„: {* age + 10 *}<br/>  
      {# å¾ªç¯è¾“å‡º #}  
      çˆ±å¥½ï¼š  
      {% for i, v in ipairs(hobby) do %}  
         {% if v == 'ç”µå½±' then  %} - xxoo
            
              {%else%}  - {* v *} 
{% end %}  
         
      {% end %}<br/>  
  
      æˆç»©ï¼š  
      {% local i = 1; %}  
      {% for k, v in pairs(score) do %}  
         {% if i > 1 then %}ï¼Œ{% end %}  
         {* k *} = {* v *}  
         {% i = i + 1 %}  
      {% end %}<br/>  
      æˆç»©2ï¼š  
      {% for i = 1, #score2 do local t = score2[i] %}  
         {% if i > 1 then %}ï¼Œ{% end %}  
          {* t.name *} = {* t.score *}  
      {% end %}<br/>  
      {# ä¸­é—´å†…å®¹ä¸è§£æ #}  
      {-raw-}{(file)}{-raw-}  
{(footer.html)}  

```







### layout å¸ƒå±€ç»Ÿä¸€é£æ ¼

ä½¿ç”¨æ¨¡æ¿å†…å®¹åµŒå¥—å¯ä»¥å®ç°å…¨ç«™é£æ ¼åŒä¸€å¸ƒå±€

#### lua

`local template = require "resty.template"`

ä¸€ã€

```
local layout   = template.new "layout.html"

layout.title   = "Testing lua-resty-template"

layout.view    = template.compile "view.html" { message = "Hello, World!" }

layout:render()
```





äºŒã€

```
template.render("layout.html", {

  title = "Testing lua-resty-template",

  msg = "type=2",

  view  = template.compile "view.html" { message = "Hello, World!" }

})
```





ä¸‰ã€

æ­¤æ–¹å¼é‡åå˜é‡å€¼ä¼šè¢«è¦†ç›–

```
local view     = template.new("view.html", "layout.html")

view.title     = "Testing lua-resty-template"

view.msg = "type=3"

view.message   = "Hello, World!"

view:render()
```





å››ã€

å¯ä»¥åŒºåˆ†ä¸€ä¸‹

```
local layout   = template.new "layout.html"

layout.title   = "Testing lua-resty-template"

layout.msg = "type=4"

local view     = template.new("view.html", layout)

view.message   = "Hello, World!"

view:render()
```





 

#### layout.html

```
<!DOCTYPE html>

<html>

<head>

â€‹    <title>{{title}}</title>

</head>

<h1>layout</h1>

<body>

â€‹    {*view*}

</body>

</html>
```





#### view.htmlÂ·

`msg:{{message}}`

 

#### å¤šçº§åµŒå¥—

lua

```
local view     = template.new("view.html", "layout.html")

view.title     = "Testing lua-resty-template"

view.message   = "Hello, World!"

view:render()

view.html

{% layout="section.html" %}
```





<h1>msg:{{message}}</h1>
section.html

<div
id="section">

â€‹    {*view*} - sss

</div>

layout.html

<!DOCTYPE html>

<html>

<head>

â€‹    <title>{{title}}</title>

</head>

<h1>layout {{msg}}</h1>
<body>

â€‹    {*view*}

</body>

</html>















## IDE Lua è„šæœ¬è°ƒè¯•

### EmmyLuaæ’ä»¶

https://github.com/EmmyLua/IntelliJ-EmmyLua

https://emmylua.github.io/zh_CN/

### LDT åŸºäºeclipse

https://www.eclipse.org/ldt/

 

 

## é™æµ

### é™æµç®—æ³•

#### æ¼æ¡¶ç®—æ³•

â€‹                                                  

#### ä»¤ç‰Œæ¡¶ç®—æ³•

   

#### è®¡æ•°å™¨

å¸¸è§çš„è¿æ¥æ± ã€çº¿ç¨‹æ± ç­‰ç®€å•ç²—æš´çš„æŒ‰ç…§æ•°é‡é™æµçš„æ–¹å¼

### Tomcaté™æµ

server.xmlé…ç½®æ–‡ä»¶ä¸­çš„ConnectorèŠ‚ç‚¹

<Connector port="8080" protocol="HTTP/1.1" connectionTimeout="20000" redirectPort="8443" 

maxConnections="800" acceptCount="500" maxThreads="400" />

l   maxThreadsï¼štomcatèƒ½å¹¶å‘å¤„ç†çš„æœ€å¤§çº¿ç¨‹æ•°

l   acceptCountï¼šå½“tomcatèµ·åŠ¨çš„çº¿ç¨‹æ•°è¾¾åˆ°æœ€å¤§æ—¶ï¼Œæ¥å—æ’é˜Ÿçš„è¯·æ±‚ä¸ªæ•°ï¼Œé»˜è®¤å€¼ä¸º100 

l   maxConnectionsï¼šç¬æ—¶æœ€å¤§è¿æ¥æ•°ï¼Œè¶…å‡ºä¼šæ’é˜Ÿç­‰å¾…

 

## Lua å¼€æºé¡¹ç›®

### WAF

https://github.com/unixhot/waf

https://github.com/loveshell/ngx_lua_waf

 

l   é˜²æ­¢ SQL æ³¨å…¥ï¼Œæœ¬åœ°åŒ…å«ï¼Œéƒ¨åˆ†æº¢å‡ºï¼Œfuzzing æµ‹è¯•ï¼ŒXSS/SSRF ç­‰ Web æ”»å‡»

l   é˜²æ­¢ Apache Bench ä¹‹ç±»å‹åŠ›æµ‹è¯•å·¥å…·çš„æ”»å‡»

l   å±è”½å¸¸è§çš„æ‰«æé»‘å®¢å·¥å…·ï¼Œæ‰«æå™¨

l   å±è”½å›¾ç‰‡é™„ä»¶ç±»ç›®å½•æ‰§è¡Œæƒé™ã€é˜²æ­¢ webshell ä¸Šä¼ 

l   æ”¯æŒ IP ç™½åå•å’Œé»‘åå•åŠŸèƒ½ï¼Œç›´æ¥å°†é»‘åå•çš„ IP è®¿é—®æ‹’ç»

l   æ”¯æŒ URL ç™½åå•ï¼Œå°†ä¸éœ€è¦è¿‡æ»¤çš„ URL è¿›è¡Œå®šä¹‰

l   æ”¯æŒ User-Agent çš„è¿‡æ»¤ã€æ”¯æŒ CC æ”»å‡»é˜²æŠ¤ã€é™åˆ¶å•ä¸ª URL æŒ‡å®šæ—¶é—´çš„è®¿é—®æ¬¡æ•°

l   æ”¯æŒæ”¯æŒ Cookie è¿‡æ»¤ï¼ŒURL ä¸ URL å‚æ•°è¿‡æ»¤

l   æ”¯æŒæ—¥å¿—è®°å½•ï¼Œå°†æ‰€æœ‰æ‹’ç»çš„æ“ä½œï¼Œè®°å½•åˆ°æ—¥å¿—ä¸­å»

### Kong åŸºäºOpenrestyçš„æµé‡ç½‘å…³

https://konghq.com/

https://github.com/kong/kong

Kong åŸºäº OpenRestyï¼Œæ˜¯ä¸€ä¸ªäº‘åŸç”Ÿã€å¿«é€Ÿã€å¯æ‰©å±•ã€åˆ†å¸ƒå¼çš„å¾®æœåŠ¡æŠ½è±¡å±‚ï¼ˆMicroservice Abstraction Layerï¼‰ï¼Œä¹Ÿå« API ç½‘å…³ï¼ˆAPI Gatewayï¼‰ï¼Œåœ¨ Service Mesh é‡Œä¹Ÿå« API ä¸­é—´ä»¶ï¼ˆAPI Middlewareï¼‰ã€‚

Kong å¼€æºäº 2015 å¹´ï¼Œæ ¸å¿ƒä»·å€¼åœ¨äºé«˜æ€§èƒ½å’Œæ‰©å±•æ€§ã€‚ä»å…¨çƒ 5000 å¼ºçš„ç»„ç»‡ç»Ÿè®¡æ•°æ®æ¥çœ‹ï¼ŒKong æ˜¯ç°åœ¨ä¾ç„¶åœ¨ç»´æŠ¤çš„ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æœ€å¹¿æ³›çš„ API ç½‘å…³ã€‚

Kong å®£ç§°è‡ªå·±æ˜¯ä¸–ç•Œä¸Šæœ€æµè¡Œçš„å¼€æºå¾®æœåŠ¡ API ç½‘å…³ï¼ˆThe Worldâ€™s Most Popular Open Source Microservice API Gatewayï¼‰ã€‚

æ ¸å¿ƒä¼˜åŠ¿ï¼š

l   å¯æ‰©å±•ï¼šå¯ä»¥æ–¹ä¾¿çš„é€šè¿‡æ·»åŠ èŠ‚ç‚¹æ°´å¹³æ‰©å±•ï¼Œè¿™æ„å‘³ç€å¯ä»¥åœ¨å¾ˆä½çš„å»¶è¿Ÿä¸‹æ”¯æŒå¾ˆå¤§çš„ç³»ç»Ÿè´Ÿè½½ã€‚

l   æ¨¡å—åŒ–ï¼šå¯ä»¥é€šè¿‡æ·»åŠ æ–°çš„æ’ä»¶æ¥æ‰©å±• Kong çš„èƒ½åŠ›ï¼Œè¿™äº›æ’ä»¶å¯ä»¥é€šè¿‡ RESTful Admin API æ¥å®‰è£…å’Œé…ç½®ã€‚

l   åœ¨ä»»ä½•åŸºç¡€æ¶æ„ä¸Šè¿è¡Œï¼šKong å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹éƒ½èƒ½è¿è¡Œï¼Œæ¯”å¦‚åœ¨äº‘æˆ–æ··åˆç¯å¢ƒä¸­éƒ¨ç½² Kongï¼Œå•ä¸ªæˆ–å…¨çƒçš„æ•°æ®ä¸­å¿ƒã€‚

   

### ABTestingGateway

https://github.com/CNSRE/ABTestingGateway

ABTestingGateway æ˜¯ä¸€ä¸ªå¯ä»¥åŠ¨æ€è®¾ç½®åˆ†æµç­–ç•¥çš„ç½‘å…³ï¼Œå…³æ³¨ä¸ç°åº¦å‘å¸ƒç›¸å…³é¢†åŸŸï¼ŒåŸºäº Nginx å’Œ ngx-lua å¼€å‘ï¼Œä½¿ç”¨ Redis ä½œä¸ºåˆ†æµç­–ç•¥æ•°æ®åº“ï¼Œå¯ä»¥å®ç°åŠ¨æ€è°ƒåº¦åŠŸèƒ½ã€‚

ABTestingGateway æ˜¯æ–°æµªå¾®åšå†…éƒ¨çš„åŠ¨æ€è·¯ç”±ç³»ç»Ÿ dygateway çš„ä¸€éƒ¨åˆ†ï¼Œç›®å‰å·²ç»å¼€æºã€‚åœ¨ä»¥å¾€çš„åŸºäº Nginx å®ç°çš„ç°åº¦ç³»ç»Ÿä¸­ï¼Œåˆ†æµé€»è¾‘å¾€å¾€é€šè¿‡ rewrite é˜¶æ®µçš„ if å’Œ rewrite æŒ‡ä»¤ç­‰å®ç°ï¼Œä¼˜ç‚¹æ˜¯æ€§èƒ½è¾ƒé«˜ï¼Œç¼ºç‚¹æ˜¯åŠŸèƒ½å—é™ã€å®¹æ˜“å‡ºé”™ï¼Œä»¥åŠè½¬å‘è§„åˆ™å›ºå®šï¼Œåªèƒ½é™æ€åˆ†æµã€‚ABTestingGateway åˆ™é‡‡ç”¨ ngx-luaï¼Œé€šè¿‡å¯ç”¨ lua-shared-dict å’Œ lua-resty-lock ä½œä¸ºç³»ç»Ÿç¼“å­˜å’Œç¼“å­˜é”ï¼Œç³»ç»Ÿè·å¾—äº†è¾ƒä¸ºæ¥è¿‘åŸç”Ÿ Nginx è½¬å‘çš„æ€§èƒ½ã€‚

l   æ”¯æŒå¤šç§åˆ†æµæ–¹å¼ï¼Œç›®å‰åŒ…æ‹¬ iprangeã€uidrangeã€uid å°¾æ•°å’ŒæŒ‡å®šuidåˆ†æµ

l   æ”¯æŒå¤šçº§åˆ†æµï¼ŒåŠ¨æ€è®¾ç½®åˆ†æµç­–ç•¥ï¼Œå³æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯

l   å¯æ‰©å±•æ€§ï¼Œæä¾›äº†å¼€å‘æ¡†æ¶ï¼Œå¼€å‘è€…å¯ä»¥çµæ´»æ·»åŠ æ–°çš„åˆ†æµæ–¹å¼ï¼Œå®ç°äºŒæ¬¡å¼€å‘

l   é«˜æ€§èƒ½ï¼Œå‹æµ‹æ•°æ®æ¥è¿‘åŸç”Ÿ Nginx è½¬å‘

l   ç°åº¦ç³»ç»Ÿé…ç½®å†™åœ¨ Nginx é…ç½®æ–‡ä»¶ä¸­ï¼Œæ–¹ä¾¿ç®¡ç†å‘˜é…ç½®

l   é€‚ç”¨äºå¤šç§åœºæ™¯ï¼šç°åº¦å‘å¸ƒã€AB æµ‹è¯•å’Œè´Ÿè½½å‡è¡¡ç­‰
